<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrewAI News Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        .step-card {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .step-card.active {
            border-left: 4px solid #0d6efd;
            background-color: #f8f9fa;
        }
        .step-card.completed {
            border-left: 4px solid #198754;
        }
        .step-card.error {
            border-left: 4px solid #dc3545;
        }
        .progress-bar-animated {
            transition: width 0.3s ease;
        }
        .statistics-card {
            margin-top: 2rem;
        }
        .alert-success {
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .news-row-relevant {
            background-color: #d4edda !important;
        }
        .news-row-relevant:hover {
            background-color: #c3e6cb !important;
        }
        .news-article-group {
            border-top: 2px solid #dee2e6;
        }
        .news-article-group:first-child {
            border-top: none;
        }
        .news-article-group.news-main-row {
            border-left: 3px solid transparent;
        }
        .news-article-group.news-relevant.news-main-row {
            border-left-color: #198754;
        }
        .news-article-group.news-detail-row {
            border-left: 3px solid transparent;
            padding-left: 1.5rem !important;
        }
        .news-article-group.news-relevant.news-detail-row {
            border-left-color: #198754;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-newspaper"></i> CrewAI News Agent
                </h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-sliders"></i> Текущие настройки системы</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Модель LLM:</small>
                                <div class="fw-bold">{{ settings.llm_model }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Temperature:</small>
                                <div class="fw-bold">{{ settings.llm_temperature }}</div>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Порог схожести:</small>
                                <div class="fw-bold">{{ settings.similarity_threshold }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">API Endpoint:</small>
                                <div class="fw-bold small">{{ settings.openai_api_base }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> Настройки обработки</h5>
                    </div>
                    <div class="card-body">
                        <form id="processingForm">
                            <div class="mb-3">
                                <label for="rss_feeds" class="form-label">RSS каналы (по одному на строку)</label>
                                <textarea class="form-control" id="rss_feeds" rows="8" 
                                    placeholder="https://example.com/feed1.xml&#10;https://example.com/feed2.xml" required></textarea>
                                <small class="form-text text-muted">Введите URL RSS каналов, каждый с новой строки</small>
                            </div>
                            <div class="mb-3">
                                <label for="criteria" class="form-label">Критерий отбора новостей</label>
                                <input type="text" class="form-control" id="criteria" 
                                    placeholder="новости о технологиях и искусственном интеллекте" required>
                                <small class="form-text text-muted">Опишите критерий релевантности новостей</small>
                            </div>
                            
                            <hr>
                            <h6 class="mb-3"><i class="bi bi-sliders"></i> Дополнительные настройки</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="llm_model" class="form-label">Модель LLM</label>
                                    <input type="text" class="form-control" id="llm_model" 
                                        value="{{ settings.llm_model }}" placeholder="gpt-4o-mini">
                                    <small class="form-text text-muted">Модель для классификации</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="llm_temperature" class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="llm_temperature" 
                                        value="{{ settings.llm_temperature }}" step="0.1" min="0" max="2">
                                    <small class="form-text text-muted">Температура LLM (0.0-2.0)</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="similarity_threshold" class="form-label">Порог схожести для дедупликации</label>
                                <input type="number" class="form-control" id="similarity_threshold" 
                                    value="{{ settings.similarity_threshold }}" step="0.01" min="0" max="1">
                                <small class="form-text text-muted">Порог для определения дубликатов (0.0-1.0)</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-2" id="startBtn">
                                <i class="bi bi-play-circle"></i> Начать обработку
                            </button>
                            <button type="button" class="btn btn-outline-danger w-100" id="clearDbBtn" data-bs-toggle="modal" data-bs-target="#clearDbModal">
                                <i class="bi bi-trash"></i> Очистить базу данных
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-activity"></i> Прогресс выполнения</h5>
                    </div>
                    <div class="card-body" id="progressContainer">
                        <div class="text-center text-muted py-5" id="emptyState">
                            <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
                            <p class="mt-3">Ожидание запуска обработки...</p>
                        </div>
                        <div id="stepsContainer" style="display: none;">
                            <!-- Шаги будут добавлены динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="statisticsRow" style="display: none;">
            <div class="col-12">
                <div class="card statistics-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Итоговая статистика</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="statisticsContent">
                            <!-- Статистика будет добавлена динамически -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-success alert-dismissible fade" role="alert" id="successAlert" style="display: none;">
            <i class="bi bi-check-circle"></i> <strong>Обработка завершена успешно!</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="alert alert-danger alert-dismissible fade" role="alert" id="errorAlert" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i> <strong>Ошибка:</strong> <span id="errorMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Новости</h5>
                        <button class="btn btn-sm btn-light" id="refreshNewsBtn" onclick="loadNews()">
                            <i class="bi bi-arrow-clockwise"></i> Обновить
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="newsContainer" class="table-responsive" style="max-height: 1200px; overflow-y: auto;">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 5%;">ID</th>
                                        <th style="width: 20%;">Источник</th>
                                        <th style="width: 15%;">Дата</th>
                                        <th style="width: 50%;">Заголовок</th>
                                        <th style="width: 10%;">Релевантность</th>
                                    </tr>
                                </thead>
                                <tbody id="newsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split"></i> Загрузка новостей...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Модальное окно подтверждения очистки БД -->
        <div class="modal fade" id="clearDbModal" tabindex="-1" aria-labelledby="clearDbModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clearDbModalLabel">
                            <i class="bi bi-exclamation-triangle text-warning"></i> Подтверждение очистки
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Вы уверены, что хотите очистить базу данных?</p>
                        <p class="text-danger"><strong>Это действие нельзя отменить!</strong> Все сохраненные новости будут удалены.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-danger" id="confirmClearBtn">
                            <i class="bi bi-trash"></i> Да, очистить базу
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTaskId = null;
        let statusInterval = null;

        const form = document.getElementById('processingForm');
        const startBtn = document.getElementById('startBtn');
        const progressContainer = document.getElementById('progressContainer');
        const emptyState = document.getElementById('emptyState');
        const stepsContainer = document.getElementById('stepsContainer');
        const statisticsRow = document.getElementById('statisticsRow');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const confirmClearBtn = document.getElementById('confirmClearBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const rssFeeds = document.getElementById('rss_feeds').value;
            const criteria = document.getElementById('criteria').value;
            const llmModel = document.getElementById('llm_model').value.trim();
            const llmTemperature = parseFloat(document.getElementById('llm_temperature').value);
            const similarityThreshold = parseFloat(document.getElementById('similarity_threshold').value);

            if (!rssFeeds.trim() || !criteria.trim()) {
                alert('Заполните обязательные поля: RSS каналы и критерий отбора');
                return;
            }

            // Валидация параметров
            if (isNaN(llmTemperature) || llmTemperature < 0 || llmTemperature > 2) {
                alert('Temperature должен быть числом от 0.0 до 2.0');
                return;
            }

            if (isNaN(similarityThreshold) || similarityThreshold < 0 || similarityThreshold > 1) {
                alert('Порог схожести должен быть числом от 0.0 до 1.0');
                return;
            }

            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Запуск...';

            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rss_feeds: rssFeeds,
                        criteria: criteria,
                        llm_model: llmModel,
                        llm_temperature: llmTemperature,
                        similarity_threshold: similarityThreshold
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentTaskId = data.task_id;
                    emptyState.style.display = 'none';
                    stepsContainer.style.display = 'block';
                    initializeSteps();
                    startStatusPolling();
                } else {
                    showError(data.error || 'Ошибка при запуске обработки');
                }
            } catch (error) {
                showError('Ошибка при отправке запроса: ' + error.message);
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Начать обработку';
            }
        });

        function initializeSteps() {
            stepsContainer.innerHTML = '';
            const steps = [
                'Сбор новостей из RSS каналов',
                'Дедупликация статей',
                'Классификация по релевантности'
            ];

            steps.forEach((stepName, index) => {
                const stepCard = document.createElement('div');
                stepCard.className = 'card step-card';
                stepCard.id = `step-${index}`;
                stepCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="bi bi-circle" id="icon-${index}"></i> ${stepName}
                            </h6>
                            <span class="badge bg-secondary" id="status-${index}">Ожидание</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" id="progress-${index}" role="progressbar" 
                                style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted" id="message-${index}"></small>
                    </div>
                `;
                stepsContainer.appendChild(stepCard);
            });
        }

        function startStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }

            statusInterval = setInterval(async () => {
                if (!currentTaskId) return;

                try {
                    const response = await fetch(`/api/status/${currentTaskId}`);
                    const status = await response.json();

                    updateProgress(status);

                    if (status.status === 'completed' || status.status === 'error') {
                        clearInterval(statusInterval);
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Начать обработку';

                        if (status.status === 'completed') {
                            showSuccess();
                            showStatistics(status.statistics);
                        } else {
                            showError(status.error_message || 'Произошла ошибка при обработке');
                        }
                    }
                } catch (error) {
                    console.error('Ошибка при получении статуса:', error);
                }
            }, 1000);
        }

        function updateProgress(status) {
            status.steps.forEach((step, index) => {
                const stepCard = document.getElementById(`step-${index}`);
                const icon = document.getElementById(`icon-${index}`);
                const statusBadge = document.getElementById(`status-${index}`);
                const progressBar = document.getElementById(`progress-${index}`);
                const message = document.getElementById(`message-${index}`);

                // Обновление класса карточки
                stepCard.className = 'card step-card';
                if (step.status === 'running') {
                    stepCard.classList.add('active');
                    icon.className = 'bi bi-arrow-repeat pulse';
                    statusBadge.className = 'badge bg-primary';
                    statusBadge.textContent = 'Выполняется';
                } else if (step.status === 'completed') {
                    stepCard.classList.add('completed');
                    icon.className = 'bi bi-check-circle-fill text-success';
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Завершено';
                } else if (step.status === 'error') {
                    stepCard.classList.add('error');
                    icon.className = 'bi bi-x-circle-fill text-danger';
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = 'Ошибка';
                } else {
                    icon.className = 'bi bi-circle';
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.textContent = 'Ожидание';
                }

                // Обновление прогресс-бара
                progressBar.style.width = step.progress + '%';
                progressBar.setAttribute('aria-valuenow', step.progress);
                progressBar.textContent = step.progress + '%';

                // Обновление сообщения
                message.textContent = step.message || '';
            });
        }

        function showSuccess() {
            successAlert.style.display = 'block';
            successAlert.classList.add('show');
            setTimeout(() => {
                successAlert.classList.remove('show');
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 300);
            }, 5000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorAlert.style.display = 'block';
            errorAlert.classList.add('show');
        }

        function showStatistics(stats) {
            if (!stats || Object.keys(stats).length === 0) return;

            statisticsRow.style.display = 'block';
            const content = document.getElementById('statisticsContent');
            
            if (stats.message) {
                content.innerHTML = `<div class="col-12"><p class="text-muted">${stats.message}</p></div>`;
            } else {
                content.innerHTML = `
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h3 class="text-primary">${stats.total || 0}</h3>
                            <p class="mb-0 text-muted">Всего статей</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h3 class="text-success">${stats.relevant || 0}</h3>
                            <p class="mb-0 text-muted">Релевантных</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h3 class="text-warning">${stats.duplicates || 0}</h3>
                            <p class="mb-0 text-muted">Дубликатов</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h3 class="text-info">${stats.unique_non_relevant || 0}</h3>
                            <p class="mb-0 text-muted">Уникальных нерелевантных</p>
                        </div>
                    </div>
                `;
            }
        }

        // Обработчик очистки базы данных
        confirmClearBtn.addEventListener('click', async () => {
            confirmClearBtn.disabled = true;
            confirmClearBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Очистка...';

            try {
                const response = await fetch('/api/clear-db', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // Если ответ не JSON, значит сервер вернул HTML (ошибка)
                    const text = await response.text();
                    console.error('Ошибка парсинга JSON:', text);
                    showError('Ошибка сервера: получен неверный формат ответа');
                    return;
                }

                if (response.ok && data.success) {
                    const modalElement = document.getElementById('clearDbModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    showSuccessMessage(data.message || 'База данных успешно очищена');
                    
                    // Сброс прогресса
                    emptyState.style.display = 'block';
                    stepsContainer.style.display = 'none';
                    statisticsRow.style.display = 'none';
                    currentTaskId = null;
                    if (statusInterval) {
                        clearInterval(statusInterval);
                    }
                } else {
                    showError(data.error || 'Ошибка при очистке базы данных');
                }
            } catch (error) {
                showError('Ошибка при отправке запроса: ' + error.message);
            } finally {
                confirmClearBtn.disabled = false;
                confirmClearBtn.innerHTML = '<i class="bi bi-trash"></i> Да, очистить базу';
            }
        });

        function showSuccessMessage(message) {
            successAlert.querySelector('strong').innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
            successAlert.style.display = 'block';
            successAlert.classList.add('show');
            setTimeout(() => {
                successAlert.classList.remove('show');
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 300);
            }, 5000);
        }

        // Загрузка новостей
        async function loadNews() {
            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm"></span> Загрузка...</td></tr>';

            try {
                const response = await fetch('/api/results');
                const data = await response.json();

                if (response.ok && data.articles) {
                    displayNews(data.articles);
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Ошибка при загрузке новостей</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Ошибка: ' + error.message + '</td></tr>';
            }
        }

        function displayNews(articles) {
            const tbody = document.getElementById('newsTableBody');
            
            if (articles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Новостей пока нет</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            articles.forEach(article => {
                // Основная строка
                const row = document.createElement('tr');
                row.className = 'news-article-group news-main-row';
                if (article.is_relevant) {
                    row.classList.add('news-relevant', 'news-row-relevant');
                }

                // Форматирование даты
                let dateStr = 'Не указана';
                if (article.published_at) {
                    const date = new Date(article.published_at);
                    dateStr = date.toLocaleDateString('ru-RU', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // Форматирование релевантности
                const relevanceScore = article.relevance_score !== null ? (article.relevance_score * 100).toFixed(0) : '—';
                const relevanceBadgeClass = article.is_relevant ? 'bg-success' : 'bg-secondary';
                const relevanceText = article.is_relevant ? 'Релевантно' : 'Не релевантно';

                row.innerHTML = `
                    <td class="align-middle">
                        <small class="text-muted">${article.id}</small>
                    </td>
                    <td class="align-middle">
                        <small class="news-meta">${escapeHtml(article.source)}</small>
                    </td>
                    <td class="align-middle">
                        <small class="news-meta">${dateStr}</small>
                    </td>
                    <td class="align-middle">
                        <div class="news-title">${escapeHtml(article.title)}</div>
                    </td>
                    <td class="align-middle">
                        <div>
                            <span class="badge ${relevanceBadgeClass} relevance-badge">${relevanceText}</span>
                            <small class="d-block text-muted mt-1">${relevanceScore}%</small>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);

                // Строка с содержанием (если есть)
                if (article.content && article.content.trim()) {
                    const contentRow = document.createElement('tr');
                    contentRow.className = 'news-article-group news-detail-row';
                    if (article.is_relevant) {
                        contentRow.classList.add('news-relevant', 'news-row-relevant');
                    }
                    // Санитизация HTML для безопасного отображения с сохранением разметки
                    const sanitizedContent = DOMPurify.sanitize(article.content, {
                        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'a', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'code', 'pre', 'div', 'span'],
                        ALLOWED_ATTR: ['href', 'target', 'rel', 'class']
                    });
                    contentRow.innerHTML = `
                        <td colspan="5" class="py-2 px-3">
                            <div class="news-content-full">${sanitizedContent}</div>
                        </td>
                    `;
                    tbody.appendChild(contentRow);
                }

                // Строка с причиной классификации (если есть)
                if (article.classification_reason && article.classification_reason.trim()) {
                    const reasonRow = document.createElement('tr');
                    reasonRow.className = 'news-article-group news-detail-row';
                    if (article.is_relevant) {
                        reasonRow.classList.add('news-relevant', 'news-row-relevant');
                    }
                    reasonRow.innerHTML = `
                        <td colspan="5" class="py-2 px-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> <strong>Причина:</strong> ${escapeHtml(article.classification_reason)}
                            </small>
                        </td>
                    `;
                    tbody.appendChild(reasonRow);
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Загрузка новостей при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadNews();
        });

        // Автообновление новостей после завершения обработки
        const originalShowStatistics = showStatistics;
        showStatistics = function(stats) {
            originalShowStatistics(stats);
            setTimeout(loadNews, 1000);
        };
    </script>
</body>
</html>

